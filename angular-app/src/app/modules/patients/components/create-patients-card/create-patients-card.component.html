<app-generic-card [title]="titleCard">
  <div class="card-content">

    <!-- <h6>Información básica</h6> -->
    <form (ngSubmit)="onSubmit()" [formGroup]="createPatientForm" class="form form-horizontal">
      <div class="form-body">
        <div formGroupName="patientInfoForm">
          <div class="row">

            <!-- Nombre de usuario -->
            <div class="col-md-6">
              <div class="form-group">
                <label for="username">Nombre de usuario*</label>
                <input type="text" formControlName="username" class="form-control" id="username" [attr.readonly]="true" placeholder="Nombre de usuario">
                <p><small class="text-muted">Generado a partir del DNI.</small></p>
              </div>
            </div>
            
            <!-- Email -->
            <div class="col-md-6">
              <div class="form-group">
                <label for="email">Email*</label>
                <input type="text" formControlName="email" class="form-control" id="email" placeholder="Email" 
                  [ngClass]="{ 'is-invalid': submitted && patientInfo?.get('email')?.errors }">
                <!-- Errores -->
                <div *ngIf="submitted && patientInfo?.get('email')?.errors" class="invalid-feedback">
                  <div *ngIf="patientInfo?.get('email')?.hasError('required')">El correo electrónico es obligatorio</div>
                  <div *ngIf="patientInfo?.get('email')?.hasError('email')">Correo electrónico inválido</div>
              </div>
              </div>
            </div>

            <!-- Nombre -->
            <div class="col-md-6">
              <div class="form-group">
                <label for="name">Nombre*</label>
                <input type="text" formControlName="name" class="form-control" id="name" placeholder="Nombre"
                  [ngClass]="{ 'is-invalid': submitted && patientInfo?.get('name')?.errors }">
                <!-- Errores -->
                <div *ngIf="submitted && patientInfo?.get('name')?.errors" class="invalid-feedback">
                  <div *ngIf="patientInfo?.get('name')?.hasError('required')">El nombre es obligatorio</div>
                </div>
              </div>
            </div>

            <!-- Apellidos -->
            <div class="col-md-6">
              <div class="form-group">
                <label for="last_name">Apellidos*</label>
                <input type="text" formControlName="last_name" class="form-control" id="last_name" placeholder="Apellidos"
                  [ngClass]="{ 'is-invalid': submitted && patientInfo?.get('last_name')?.errors }">
                <!-- Errores -->
                <div *ngIf="submitted && patientInfo?.get('last_name')?.errors" class="invalid-feedback">
                  <div *ngIf="patientInfo?.get('last_name')?.hasError('required')">Los apellidos son obligatorios</div>
                </div>
              </div>
            </div>

            <!-- DNI -->
            <div class="col-md-6">
              <div class="form-group">
                <label for="dni">DNI*</label>
                <input type="text" formControlName="dni" class="form-control" id="dni" placeholder="DNI"
                  [ngClass]="{ 'is-invalid': submitted && patientInfo?.get('dni')?.errors }">
                <!-- Errores -->
                <div *ngIf="submitted && patientInfo?.get('dni')?.errors" class="invalid-feedback">
                  <div *ngIf="patientInfo?.get('dni')?.hasError('required')">El DNI es obligatorio</div>
                  <div *ngIf="patientInfo?.get('dni')?.hasError('maxlength')">
                    Máx. {{ patientInfo?.get('dni')?.getError('maxlength')?.requiredLength }} caracteres, 
                    actual {{ patientInfo?.get('dni')?.getError('maxlength')?.actualLength }}
                  </div>
                </div>
              </div>
            </div>

            <!-- Nº de la seguridad social -->
            <div class="col-md-6">
              <div class="form-group">
                <label for="social_security">Nº de la seguridad social</label>
                <input type="text" formControlName="social_security" class="form-control" id="social_security" placeholder="Nº de la seguridad social"
                  [ngClass]="{ 'is-invalid': submitted && patientInfo?.get('social_security')?.errors }">
                <!-- Errores -->
                <div *ngIf="submitted && patientInfo?.get('social_security')?.errors" class="invalid-feedback">
                  <div *ngIf="patientInfo?.get('social_security')?.hasError('maxlength')">
                    Máx. {{ patientInfo?.get('social_security')?.getError('maxlength')?.requiredLength }} caracteres, 
                    actual {{ patientInfo?.get('social_security')?.getError('maxlength')?.actualLength }}
                  </div>
                </div>
              </div>
            </div>

            <!-- Fecha nacimiento -->
            <div class="col-md-6 col-12">
              <div class="form-group">
                <label for="birthdate">Fecha de nacimiento</label>
                <input type="text" formControlName="birthdate" id="birthdate" class="form-control" [ngClass]="{ 'is-invalid': submitted && patientInfo?.get('birthdate')?.errors }"
                  mwlFlatpickr [convertModelValue]="true" [locale]="locale" [maxDate]="'today'" [allowInput]="true" [dateFormat]="'d-m-Y'" 
                  [monthSelectorType]="'dropdown'" placeholder="Fecha de nacimiento">
                <div *ngIf="submitted && patientInfo?.get('birthdate')?.errors" class="invalid-feedback">
                </div>
              </div>
            </div>

            <!-- Género -->
            <div class="col-md-6">
              <fieldset class="form-group">
                <label for="gender">Género*</label>
                <select class="form-select" formControlName="gender" id="gender" [ngClass]="{ 'is-invalid': submitted && patientInfo?.get('gender')?.errors }">
                  <option value="" selected>--</option>
                  <option *ngFor="let option of gender_options" [value]="option.value">
                    {{ option.text }}
                  </option>
                </select>
                <!-- Errores -->
                <div *ngIf="submitted && patientInfo?.get('gender')?.errors" class="invalid-feedback">
                  <div *ngIf="patientInfo?.get('gender')?.hasError('required')">El género es obligatorio</div>
                </div>
              </fieldset>
            </div>

            <!-- Nº de teléfono -->
            <div class="col-md-6">
              <div class="form-group">
                <label for="phone">Nº de teléfono</label>
                <input type="text" formControlName="phone" class="form-control" id="phone" placeholder="Nº de teléfono" 
                  [ngClass]="{ 'is-invalid': submitted && patientInfo?.get('phone')?.errors }">
                <!-- Errores -->
                <div *ngIf="submitted && patientInfo?.get('phone')?.errors" class="invalid-feedback">
                  <div *ngIf="patientInfo?.get('phone')?.hasError('pattern')">Formato incorrecto</div>
                </div>
              </div>
            </div>

          </div>
        </div>
          

        <!-- Botón para añadir dirección -->
        <div class="col-md-12 my-4">
          <ng-container *ngIf="!showAddressInputs; else notShowAddressInputs">
            <button class="btn btn-light" (click)="toggleAddressInputs()">
              <i class="bi bi-plus-circle me-1"></i>
              Añadir dirección
            </button>
          </ng-container>
          <ng-template  #notShowAddressInputs>
            <button class="btn btn-danger" (click)="toggleAddressInputs()">
              <i class="bi bi-dash-circle me-1"></i>
              Eliminar dirección
            </button>
          </ng-template>
        </div>

        <ng-container *ngIf="showAddressInputs">
          <div formGroupName="addressForm">
            <div class="row">

              <!-- Calle -->
              <div class="col-xl-6 col-12">
                <div class="form-group">
                  <label for="street">Calle*</label>
                  <input type="text" formControlName="street" id="street" class="form-control" placeholder="Calle"
                    [ngClass]="{ 'is-invalid': submitted && address?.get('street')?.errors }">
                  <!-- Errores -->
                  <div *ngIf="submitted && address?.get('street')?.errors" class="invalid-feedback">
                    <div *ngIf="address?.get('street')?.hasError('required')">La calle es obligatoria</div>
                    <div *ngIf="address?.get('street')?.hasError('maxlength')">
                      Máx. {{ address?.get('street')?.getError('maxlength').requiredLength }} caracteres,
                      actual {{ address?.get('street')?.getError('maxlength').actualLength }}
                    </div>
                  </div>
                </div>
              </div>

              <!-- Número -->
              <div class="col-xl-3 col-sm-6 col-12">
                <div class="form-group">
                  <label for="number">Número*</label>
                  <input type="text" formControlName="number" id="number" class="form-control" placeholder="Número"
                    [ngClass]="{ 'is-invalid': submitted && address?.get('number')?.errors }">
                  <div *ngIf="submitted && address?.get('number')?.errors" class="invalid-feedback">
                    <div *ngIf="address?.get('number')?.hasError('required')">El número es obligatorio</div>
                    <div *ngIf="address?.get('number')?.hasError('pattern')">Debe introducir un valor numérico</div>
                  </div>
                </div>
              </div>

              <!-- Piso -->
              <div class="col-xl-3 col-sm-6 col-12">
                <div class="form-group">
                  <label for="floor">Piso</label>
                  <input type="text" formControlName="floor" id="floor" class="form-control" placeholder="Piso"
                    [ngClass]="{ 'is-invalid': submitted && address?.get('floor')?.errors }">
                  <div *ngIf="submitted && address?.get('floor')?.errors" class="invalid-feedback">
                    <div *ngIf="address?.get('floor')?.hasError('maxlength')">
                      Máx. {{ address?.get('floor')?.getError('maxlength').requiredLength }} caracteres,
                      actual {{ address?.get('floor')?.getError('maxlength').actualLength }}
                    </div>
                  </div>
                </div>
              </div>

              <!-- Ciudad -->
              <div class="col-xl-6 col-12">
                <div class="form-group">
                  <label for="city">Ciudad*</label>
                  <input type="text" formControlName="city" id="city" class="form-control" placeholder="Ciudad"
                    [ngClass]="{ 'is-invalid': submitted && address?.get('city')?.errors }">
                  <div *ngIf="submitted && address?.get('city')?.errors" class="invalid-feedback">
                    <div *ngIf="address?.get('city')?.hasError('required')">La ciudad es obligatoria</div>
                    <div *ngIf="address?.get('city')?.hasError('maxlength')">
                      Máx. {{ address?.get('city')?.getError('maxlength').requiredLength }} caracteres,
                      actual {{ address?.get('city')?.getError('maxlength').actualLength }}
                    </div>
                  </div>
                </div>
              </div>

              <!-- Código Postal -->
              <div class="col-xl-6 col-12">
                <div class="form-group">
                  <label for="postal_code">Código Postal*</label>
                  <input type="text" formControlName="postal_code" id="postal_code" class="form-control" placeholder="Código Postal"
                    [ngClass]="{ 'is-invalid': submitted && address?.get('postal_code')?.errors }">
                  <div *ngIf="submitted && address?.get('postal_code')?.errors" class="invalid-feedback">
                    <div *ngIf="address?.get('postal_code')?.hasError('required')">El código postal es obligatorio</div>
                    <div *ngIf="address?.get('postal_code')?.hasError('pattern')">Debe introducir un valor numérico</div>
                    <div *ngIf="address?.get('postal_code')?.hasError('maxlength')">
                      Máx. {{ address?.get('postal_code')?.getError('maxlength').requiredLength }} caracteres,
                      actual {{ address?.get('postal_code')?.getError('maxlength').actualLength }}
                    </div>
                  </div>
                </div>
              </div>

              <!-- Provincia -->
              <div class="col-md-6 col-12">
                <div class="form-group">
                  <label for="province">Provincia*</label>
                  <input type="text" formControlName="province" id="province" class="form-control" placeholder="Provincia"
                    [ngClass]="{ 'is-invalid': submitted && address?.get('province')?.errors }">
                  <div *ngIf="submitted && address?.get('province')?.errors" class="invalid-feedback">
                    <div *ngIf="address?.get('province')?.hasError('required')">La provincia es obligatoria</div>
                    <div *ngIf="address?.get('province')?.hasError('maxlength')">
                      Máx. {{ address?.get('province')?.getError('maxlength').requiredLength }} caracteres,
                      actual {{ address?.get('province')?.getError('maxlength').actualLength }}
                    </div>
                  </div>
                </div>
              </div>

              <!-- País -->
              <div class="col-md-6 col-12">
                <div class="form-group">
                  <label for="country">País*</label>
                  <input type="text" formControlName="country" id="country" class="form-control" placeholder="País"
                    [ngClass]="{ 'is-invalid': submitted && address?.get('country')?.errors }">
                  <div *ngIf="submitted && address?.get('country')?.errors" class="invalid-feedback">
                    <div *ngIf="address?.get('country')?.hasError('required')">El país es obligatorio</div>
                    <div *ngIf="address?.get('country')?.hasError('maxlength')">
                      Máx. {{ address?.get('country')?.getError('maxlength').requiredLength }} caracteres,
                      actual {{ address?.get('country')?.getError('maxlength').actualLength }}
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </ng-container>

        <!-- Botones -->
        <div class="col-12 d-flex justify-content-end">
          <button type="reset" class="btn btn-outline-primary me-1">Limpiar</button>
          <button type="submit" class="btn btn-primary">Crear</button>
        </div>

      </div>
    </form>

  </div>
</app-generic-card>